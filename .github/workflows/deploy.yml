name: Deploy

on:
  release:
    types: [released]

jobs:
  deploy:
    name: deploy-terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # Extract list of labels designating the release type
      - name: Get release type
        id: release_type
        run: |
          gh api -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /repos/$GITHUB_REPOSITORY/pulls?state=all | jq '.[0].labels[].name'
          label_list_string=$(gh api -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /repos/$GITHUB_REPOSITORY/pulls?state=all | jq '.[0].labels[].name')

          if echo "$label_list_string" | grep -q '"app"'; then
              echo "is_app_release=true" >> $GITHUB_OUTPUT
          fi

          if echo "$label_list_string" | grep -q '"terraform"'; then
              echo "is_terraform_release=true" >> $GITHUB_OUTPUT
          fi

        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Deploying/analyzing depending on release type
      - name: Deploy Terraform
        if: steps.release_type.outputs.is_terraform_release == 'true'
        run: echo "Deploying Terraform..."
      
      - name: Deploy app
        if: steps.release_type.outputs.is_app_release == 'true'
        run: echo "Deploying app..."

